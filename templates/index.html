<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIDS App Runner - MRI-Lab Graz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-bottom: 50px; }
        .navbar { background-color: var(--primary-color); color: white; margin-bottom: 30px; border-bottom: 4px solid var(--accent-color); padding: 15px 0; }
        .navbar-brand { font-weight: 700; color: white !important; font-size: 1.5rem; }
        .branding-sub { font-size: 0.85rem; opacity: 0.8; margin-top: -2px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: hidden; }
        .card-header { background-color: #fff; border-bottom: 1px solid #f0f0f0; font-weight: 700; color: var(--primary-color); padding: 15px 25px; }
        .section-header { border-bottom: 2px solid var(--accent-color); margin: 30px 0 15px 0; padding-bottom: 8px; color: var(--primary-color); font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn { border-radius: 6px; font-weight: 600; padding: 10px 20px; transition: all 0.2s; }
        .btn-primary { background-color: var(--accent-color); border: none; }
        .btn-primary:hover { background-color: #2980b9; transform: translateY(-1px); }
        .btn-accent { background-color: #8e44ad; color: white; border: none; }
        .btn-accent:hover { background-color: #7d3c98; transform: translateY(-1px); color: white; }
        .form-label { font-weight: 600; color: #495057; font-size: 0.9rem; margin-bottom: 8px; }
        .form-control, .form-select { border-radius: 6px; padding: 10px 12px; border: 1px solid #dee2e6; }
        .form-control:focus, .form-select:focus { box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.15); border-color: var(--accent-color); }
        
        /* Terminal Styling */
        .terminal-container { margin-top: 40px; }
        .terminal-header { background: #333; color: #efefef; padding: 10px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; font-family: sans-serif; font-size: 0.9rem; }
        #terminal {
            background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 0 0 8px 8px; 
            height: 400px; overflow-y: auto; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
            font-size: 0.85rem; border: 1px solid #333; margin: 0; white-space: pre-wrap; 
            word-wrap: break-word; line-height: 1.5;
        }
        
        .opt-section { border: 1px solid #f0f0f0; margin-bottom: 12px; border-radius: 8px; overflow: hidden; }
        .opt-section-header { background: #fcfcfc; padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .opt-section-header:hover { background: #f8f9fa; }
        .opt-section-header i { transition: transform 0.3s ease; color: #adb5bd; }
        .opt-section-content { display: none; padding: 20px; background: #fff; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .opt-section.active .opt-section-content { display: grid; }
        .opt-section.active .opt-section-header { background: #eef7ff; color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .opt-section.active .opt-section-header i { transform: rotate(180deg); color: var(--accent-color); }
        
        .footer { margin-top: 60px; padding: 40px 0; background: #fff; border-top: 1px solid #eee; }
        .footer h6 { color: var(--primary-color); font-weight: 700; }
        .footer-link { color: var(--accent-color); text-decoration: none; font-weight: 600; }
        .footer-link:hover { text-decoration: underline; }

        .tab-panel { display: none; }
        .tab-button { border-radius: 30px; font-weight: 600; }
        .utility-status { display: none; border-radius: 8px; padding: 12px 18px; min-height: 48px; font-weight: 600; }
        .utility-log { background: #0f172a; color: #f8fafc; border-radius: 10px; padding: 18px; border: 1px solid #1d2939; min-height: 180px; font-family: 'Consolas', 'Menlo', monospace; white-space: pre-wrap; overflow-y: auto; }

        #browseModal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content-dir { background: white; margin: 5% auto; width: 90%; max-width: 850px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); height: 85vh; display: flex; flex-direction: column; }
        .modal-header-dir { padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body-dir { flex-grow: 1; overflow-y: auto; padding: 20px 30px; }
        .dir-item { padding: 10px 15px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; margin-bottom: 4px; transition: background 0.2s; font-family: monospace; }
        .dir-item:hover { background: #eef7ff; color: var(--accent-color); }
        .dir-item i { margin-right: 12px; font-size: 1.1rem; }
        
        .report-item { transition: all 0.2s; border: 1px solid #eee; }
        .report-item:hover { transform: translateX(5px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .border-bottom-dotted { border-bottom: 1px dotted #ccc; }

        /* Navbar Tab Styling */
        .navbar .tab-button {
            border-radius: 20px;
            padding: 6px 18px;
            font-size: 0.85rem;
            border-width: 2px;
            transition: all 0.2s;
        }
        .navbar .btn-outline-primary {
            color: #fff;
            border-color: rgba(255,255,255,0.2);
        }
        .navbar .btn-outline-primary:hover {
            background: rgba(255,255,255,0.1);
            border-color: #fff;
            color: #fff;
        }
        .navbar .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="me-4">
                    <a class="navbar-brand" href="#"><i class="fas fa-layer-group me-2"></i>BIDS App Runner</a>
                    <div class="branding-sub">Advanced Workflow Control • MRI-Lab Graz</div>
                </div>
                <div class="btn-group ms-3" role="tablist">
                    <button class="btn btn-primary tab-button active" id="tabRunnerBtn" type="button" onclick="switchTab('runnerTab', this)">Run BIDS App</button>
                    <button class="btn btn-outline-primary tab-button" id="tabCheckBtn" type="button" onclick="switchTab('checkTab', this)">Check App Output</button>
                    <button class="btn btn-outline-primary tab-button" id="tabBuildBtn" type="button" onclick="switchTab('buildTab', this)">Build Apptainer</button>
                </div>
            </div>
            <div class="text-end d-none d-md-block">
                <a href="https://github.com/MRI-Lab-Graz/bids_apps_runner" target="_blank" class="btn btn-outline-light btn-sm"><i class="fab fa-github me-1"></i> GitHub Repo</a>
            </div>
        </div>
    </nav>

    <div class="container container-main">
        <div id="runnerTab" class="tab-panel" style="display:block;">
            <div class="card">
            <div class="card-header">
                Configuration & Launch
            </div>
            <div class="card-body">
                <form id="runnerForm">
                    <div class="section-header">1. Data Locations</div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label" title="Path to raw BIDS data (must contain dataset_description.json)">BIDS Dataset Folder</label>
                            <div class="input-group">
                                <input type="text" id="bids_folder" class="form-control" placeholder="/path/to/rawdata">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('bids_folder')">...</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="form-label" title="Where derivative results will be saved">Output Folder</label>
                            <div class="input-group">
                                <input type="text" id="output_folder" class="form-control" placeholder="/path/to/derivatives">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('output_folder')">...</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label" title="Temporary space for intermediate files (recommended for performance)">Work/Temp Folder</label>
                            <div class="input-group">
                                <input type="text" id="tmp_folder" class="form-control" placeholder="/path/to/temp">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('tmp_folder')">...</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="form-label" title="Local directory for pre-downloaded TemplateFlow resources (Optional)">Templateflow (Optional)</label>
                            <div class="input-group">
                                <input type="text" id="templateflow_dir" class="form-control">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('templateflow_dir')">...</button>
                                <button type="button" class="btn btn-primary" onclick="openTemplateFlowPicker()"><i class="fas fa-search me-1"></i> Scan</button>
                            </div>
                        </div>
                    </div>

                    <div class="section-header">2. Container Settings</div>
                    <div class="row align-items-end">
                        <div class="col-md-3 mb-4">
                            <label class="form-label">Container Engine</label>
                            <select id="container_engine" class="form-select" onchange="toggleEngineFields()">
                                <option value="apptainer" selected>Apptainer/Singularity</option>
                                <option value="docker">Docker</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-4" id="container_folder_group">
                            <label class="form-label">Apptainer Images Folder</label>
                            <div class="input-group">
                                <input type="text" id="container_folder" class="form-control">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('container_folder')">...</button>
                                <button type="button" class="btn btn-primary" onclick="scanContainers()">Scan</button>
                            </div>
                        </div>
                        <div class="col-md-5 mb-4">
                            <label class="form-label" id="container_select_label">Select App Image</label>
                            <div class="input-group" id="container_select_group">
                                <select id="container_select" class="form-select" onchange="checkAppVersion()"></select>
                                <button type="button" id="fetchHelpBtn" class="btn btn-accent" style="display:none;" onclick="fetchAppOptions()">Load Options</button>
                            </div>
                            <div class="input-group" id="container_input_group" style="display:none;">
                                <input type="text" id="container_input" class="form-control" placeholder="e.g. nipreps/fmriprep:latest">
                                <button type="button" class="btn btn-accent" onclick="fetchAppOptions()">Load Options</button>
                            </div>
                            <div id="versionAlert" style="margin-top: 8px; font-size: 0.85rem; display: none;"></div>
                        </div>
                    </div>

                    <div id="dynamicOptionsSection" style="display: none;">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>App-Specific Arguments</span>
                            <a id="docLink" href="#" target="_blank" class="footer-link" style="font-size: 0.8rem;"><i class="fas fa-book me-1"></i> Documentation</a>
                        </div>
                        <div id="optionsContainer"></div>
                    </div>

                    <div class="section-header">3. Custom Options & Mounts</div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label" title="Additional command-line arguments passed directly to the BIDS App (e.g., --fs-license-file /fs/license.txt --output-spaces MNI152NLin2009cAsym:res-native)">Custom App Arguments</label>
                            <textarea id="custom_args" class="form-control" rows="3" placeholder="--fs-license-file /fs/license.txt&#10;--output-spaces MNI152NLin2009cAsym:res-native"></textarea>
                            <div class="text-muted small mt-1">One argument per line or space-separated.</div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="form-label" title="Additional bind mounts for the container (e.g., /usr/local/freesurfer:/fs)">Custom Bind Mounts (source:target)</label>
                            <textarea id="custom_mounts" class="form-control" rows="3" placeholder="/usr/local/freesurfer:/fs"></textarea>
                            <div class="text-muted small mt-1">One mount per line (SourcePath:TargetPath).</div>
                        </div>
                    </div>

                    <div class="section-header">4. Execution Parameters</div>
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="form-label">Analysis Level</label>
                            <select class="form-select" id="analysis_level">
                                <option value="participant">Participant</option>
                                <option value="group">Group</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="form-label">Parallel Jobs</label>
                            <input type="number" class="form-control" id="jobs" value="1">
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="form-label">Config Filename</label>
                            <input type="text" class="form-control" id="config_name" placeholder="config.json">
                        </div>
                    </div>

                    <div class="section-header">4. Runner Overrides</div>
                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <label class="form-label">Log Level</label>
                            <select class="form-select runner-opt" id="runner_log_level" data-flag="--log-level" title="Set logging level for the runner script (default: INFO)">
                                <option value="INFO">INFO</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>
                        <div class="col-md-9 mb-4">
                            <label class="form-label">Filter Subjects (IDs separated by space)</label>
                            <input type="text" class="form-control runner-opt" id="runner_subjects" data-flag="--subjects" placeholder="sub-01 sub-02" title="Process only specified subjects (e.g., sub-001 sub-002)">
                        </div>
                    </div>

                    <div class="row g-3" style="background: #fdfdfd; padding: 20px; border-radius: 10px; border: 1px solid #f0f0f0; margin: 0 0 30px 0;">
                        <div class="col-md-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input runner-opt" type="checkbox" id="v_out" data-flag="--validate">
                                <label class="form-check-label" for="v_out" title="Validate outputs after processing and generate reports">Validate Outputs</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Post-run validation</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input runner-opt" type="checkbox" id="v_only" data-flag="--validate-only">
                                <label class="form-check-label" for="v_only" title="Only validate outputs, skip processing">Validate Only</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Skip processing</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input runner-opt" type="checkbox" id="force" data-flag="--force">
                                <label class="form-check-label" for="force" title="Force reprocessing of subjects even if output exists">Force Overwrite</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Ignore markers</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input runner-opt" type="checkbox" id="pilot" data-flag="--pilot">
                                <label class="form-check-label" for="pilot" title="Pilot mode: process only one randomly selected subject (forces jobs=1)">Pilot (1 Sub)</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Quick test run</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input runner-opt" type="checkbox" id="debug" data-flag="--debug">
                                <label class="form-check-label" for="debug" title="Enable debug mode with detailed container execution logs">Debug Logs</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Verbose output</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input runner-opt" type="checkbox" id="dry" data-flag="--dry-run">
                                <label class="form-check-label" for="dry" title="Show commands that would be run without executing them">Dry Run</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Simulation only</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input runner-opt" type="checkbox" id="remiss" data-flag="--reprocess-missing">
                                <label class="form-check-label" for="remiss" title="Automatically reprocess subjects with missing outputs (implies --validate)">Reprocess Missing</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Auto-recovery</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input runner-opt" type="checkbox" id="clean_markers" data-flag="--clean-success-markers">
                                <label class="form-check-label" for="clean_markers" title="Remove all success markers (forces fresh detection of already processed subjects)">Clean Markers</label>
                                <div class="text-muted" style="font-size: 0.7rem;">Reset progress</div>
                            </div>
                        </div>
                    </div>

                    <div id="statusAlert" style="display:none; padding: 15px; margin-bottom: 25px; border-radius: 8px; text-align: center; font-weight: 600;"></div>

                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                        <button class="btn btn-outline-primary" type="button" onclick="loadExistingConfig()"><i class="fas fa-folder-open me-2"></i>Load Config</button>
                        <button class="btn btn-outline-success" type="button" onclick="handleSaveAndRun(false)"><i class="fas fa-save me-2"></i>Save Only</button>
                        <button class="btn btn-danger px-4" type="button" onclick="handleSaveAndRun(true)"><i class="fas fa-play-circle me-2"></i>Save & Start Runner</button>
                        <button class="btn btn-warning" id="runApp" style="display: none;" type="button" onclick="executeNow()"><i class="fas fa-bolt me-2"></i>Run (Cached)</button>
                        <button class="btn btn-dark" id="killBtn" type="button" onclick="killApp()"><i class="fas fa-stop-circle me-2"></i>Stop Execution</button>
                    </div>
                </form>

                <!-- Terminal -->
                <div class="terminal-container">
                    <div class="terminal-header">
                        <span><i class="fas fa-terminal me-2"></i>Console Output [<span id="logFilename">none</span>]</span>
                        <div class="d-flex align-items-center">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                                <label class="form-check-label ms-1" for="autoScroll">Live Feed</label>
                            </div>
                        </div>
                    </div>
                    <pre id="terminal"></pre>
                </div>
            </div>
        </div>
    </div>
        <div id="checkTab" class="tab-panel">
            <div class="card">
                <div class="card-header">Check App Output</div>
                <div class="card-body">
                    <p class="text-muted mb-3">Validate derivative outputs before reprocessing. Run the CLI checker directly from the GUI.</p>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">BIDS Dataset Folder</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="validation_bids_folder" placeholder="/data/bids">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('validation_bids_folder')">...</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Derivatives Folder</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="validation_derivatives_folder" placeholder="/data/derivatives">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('validation_derivatives_folder')">...</button>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pipeline / App (e.g. fmriprep)</label>
                            <div class="input-group">
                                <select class="form-select" id="validation_pipeline">
                                    <option value="">Auto-detected / All</option>
                                    <option value="fmriprep">fMRIPrep</option>
                                    <option value="qsiprep">QSIPrep</option>
                                    <option value="mriqc">MRIQC</option>
                                    <option value="qsirecon">QSIRECON</option>
                                    <option value="freesurfer">FreeSurfer</option>
                                    <option value="cat12">CAT12</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" title="Scan folders for pipelines" onclick="scanValidationPipelines()">Scan</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-center gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="validation_verbose">
                                <label class="form-check-label" for="validation_verbose">Verbose</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="validation_quiet">
                                <label class="form-check-label" for="validation_quiet">Quiet</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="validation_missing_only">
                                <label class="form-check-label" for="validation_missing_only">List Missing Only</label>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-primary" id="runValidationBtn" type="button" onclick="runOutputCheck()">Run Validation</button>
                        <button class="btn btn-outline-secondary" type="button" onclick="clearValidationOutput()">Reset</button>
                    </div>
                    <div id="validationStatusBox" class="utility-status"></div>
                    
                    <div id="validationDetailsResults"></div>
                    
                    <div class="mt-3" id="validationLogHeader" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted small fw-bold uppercase">System Console Logs</span>
                            <button class="btn btn-sm btn-link text-decoration-none p-0" type="button" onclick="toggleValidationLog()">
                                <i class="fas fa-eye-slash me-1"></i><span id="logToggleText">Hide Logs</span>
                            </button>
                        </div>
                    </div>
                    <pre id="validationOutput" class="utility-log"></pre>
                </div>
            </div>
        </div>

        <div id="buildTab" class="tab-panel">
            <div class="card">
                <div class="card-header">Build Apptainer Image</div>
                <div class="card-body">
                    <p class="text-muted mb-3">Convert Docker images or Dockerfiles into Apptainer containers without leaving the browser.</p>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Docker Repository</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="build_docker_repo" placeholder="nipreps/fmriprep">
                                <button type="button" class="btn btn-outline-primary" onclick="fetchDockerTags()">Fetch Tags</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tag</label>
                            <select class="form-select" id="build_docker_tag">
                                <option value="latest">latest</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Output Directory</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="build_output_dir" placeholder="/data/local/container">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('build_output_dir')">...</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Temporary Directory</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="build_tmp_dir" placeholder="/tmp/apptainer_build">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('build_tmp_dir')">...</button>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Dockerfile (optional)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="build_dockerfile" placeholder="/path/to/Dockerfile">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('build_dockerfile')">...</button>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="build_keep_temp">
                                <label class="form-check-label" for="build_keep_temp">Preserve temp dir</label>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-accent" id="buildApptainerBtn" type="button" onclick="startApptainerBuild()">Start Build</button>
                    </div>
                    <div id="buildStatusBox" class="utility-status"></div>
                    <pre id="buildOutput" class="utility-log mt-3"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="configModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter: blur(2px);">
        <div style="background:white; margin:10% auto; padding:30px; width:90%; max-width:500px; border-radius:12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h4 class="mb-3">Select Configuration</h4>
            <div id="configList" style="max-height:300px; overflow-y:auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px;"></div>
            <div class="text-end">
                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('configModal').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter: blur(8px);">
        <div class="modal-content" style="background: white; margin: 2% auto; width: 95%; height: 90vh; border-radius: 12px; display: flex; flex-direction: column;">
            <div class="modal-header d-flex justify-content-between align-items-center p-3 border-bottom">
                <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-file-invoice me-2"></i>BIDS App HTML Report Viewer</h5>
                <button type="button" class="btn-close" onclick="closeReportModal()"></button>
            </div>
            <div class="modal-body p-0 flex-grow-1 d-flex">
                <div id="reportListSidebar" style="width: 280px; border-right: 1px solid #eee; overflow-y: auto; background: #f8f9fa;" class="p-3">
                    <h6 class="small fw-bold text-muted mb-3">Available Reports</h6>
                    <div id="reportListItems"></div>
                </div>
                <div id="reportIframeContainer" class="flex-grow-1 bg-white">
                    <iframe id="reportIframe" style="width: 100%; height: 100%; border: none;"></iframe>
                    <div id="reportPlaceholder" class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                        <i class="fas fa-file-contract fa-4x mb-3 opacity-25"></i>
                        <p>Select a subject from the list to view their interactive report.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tfModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter: blur(2px);">
        <div style="background:white; margin:5% auto; padding:30px; width:90%; max-width:800px; border-radius:12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 80vh; display: flex; flex-direction: column;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">TemplateFlow Browser</h4>
                <button type="button" class="btn-close" onclick="document.getElementById('tfModal').style.display='none'"></button>
            </div>
            <p class="text-muted small mb-3">Detected templates in your local TemplateFlow directory. Select templates and resolutions to add to your output spaces configuration.</p>
            
            <div id="tfList" style="flex-grow: 1; overflow-y:auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; padding: 15px;">
                <div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <div id="tfSelectionSummary" class="small fw-bold text-primary"></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="document.getElementById('tfModal').style.display='none'">Cancel</button>
                    <button class="btn btn-success" onclick="applyTFSelection()">Apply to Output Spaces</button>
                </div>
            </div>
        </div>
    </div>

    <div id="browseModal">
        <div class="modal-content-dir">
            <div class="modal-header-dir">
                <h5 class="mb-0"><i class="fas fa-folder-tree me-2 text-primary"></i>Folder Browser</h5>
                <button type="button" class="btn-close" onclick="closeBrowser()"></button>
            </div>
            <div class="px-4 pt-3"><div id="currentPathDisplay"></div></div>
            <div class="modal-body-dir" id="dirListing"></div>
            <div class="p-4 border-top d-flex justify-content-between">
                <button class="btn btn-outline-secondary" onclick="goUp()"><i class="fas fa-level-up-alt me-2"></i>Parent Folder</button>
                <button class="btn btn-success" onclick="selectCurrentDir()"><i class="fas fa-check-circle me-2"></i>Select Current</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <h6>MRI-Lab Graz</h6>
                    <p>8010 Graz, Austria</p>
                </div>
                <div class="col-md-4 mb-4">
                    <h6>Contact</h6>
                    <strong>Karl Koschutnig</strong><br>
                    <a href="mailto:karl.koschutnig@uni-graz.at" class="footer-link">karl.koschutnig@uni-graz.at</a>
                </div>
                <div class="col-md-4 mb-4">
                    <h6>Project</h6>
                    <a href="https://github.com/MRI-Lab-Graz/bids_apps_runner" target="_blank" class="footer-link"><i class="fab fa-github me-1"></i> Source Code</a><br>
                    <span style="font-size: 0.8rem; opacity: 0.6;">© 2026 BIDS App Runner</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let currentTargetId = '';
        let browserCurrentPath = '/data/local/software';
        let lastSavedPath = '';
        let initialLoad = true;

        async function refreshLogs() {
            if (!document.getElementById('autoScroll').checked) return;
            try {
                const resp = await fetch('/get_log');
                if (!resp.ok) return;
                const data = await resp.json();
                const term = document.getElementById('terminal');
                
                if (data.content) {
                    const isAtBottom = term.scrollHeight - term.clientHeight <= term.scrollTop + 5;
                    term.innerText = data.content;
                    document.getElementById('logFilename').innerText = data.filename || 'none';
                    if (isAtBottom) term.scrollTop = term.scrollHeight;
                } else if (!data.content && data.filename === 'none') {
                    if (initialLoad) {
                        term.innerText = '[System initialized. Waiting for task...]\n';
                        initialLoad = false;
                    }
                }
            } catch (e) {
                console.error("Log refresh failed", e);
            }
        }
        setInterval(refreshLogs, 3000);

        async function checkAppVersion() {
            const f = document.getElementById('container_folder').value;
            const c = document.getElementById('container_select').value;
            if (!c) return;
            const alertEl = document.getElementById('versionAlert');
            alertEl.style.display = 'none';

            try {
                const resp = await fetch('/check_container_version', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ container: f + '/' + c })
                });
                const data = await resp.json();
                if (data.is_newer) {
                    alertEl.innerHTML = `<span style="color: #e67e22; font-weight: bold;"><i class="fas fa-exclamation-triangle me-1"></i> Update: <a href="${data.changelog_url}" target="_blank" style="color: #d35400;">${data.latest}</a> available</span>`;
                    alertEl.style.display = 'block';
                } else if (data.latest) {
                    alertEl.innerHTML = `<span style="color: #27ae60; font-weight: bold;"><i class="fas fa-check-circle me-1"></i> Vers. ${data.latest} up-to-date</span>`;
                    alertEl.style.display = 'block';
                }
            } catch (e) {}
        }

        async function openBrowser(id) {
            console.log("Opening browser for target:", id);
            currentTargetId = id;
            const currentVal = document.getElementById(id).value;
            try {
                await loadDirectory(currentVal || browserCurrentPath);
                document.getElementById('browseModal').style.display = 'block';
                document.body.style.overflow = 'hidden'; 
            } catch (err) {
                console.error("Failed to open browser:", err);
                showStatus("Error: Could not list directory. Check console.", true);
            }
        }

        async function loadDirectory(path) {
            console.log("Fetching directory listing for:", path);
            try {
                const resp = await fetch('/list_dirs', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ path: path }) 
                });
                
                if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
                
                const data = await resp.json();
                if (data.error) throw new Error(data.error);

                browserCurrentPath = data.current_path;
                const list = document.getElementById('dirListing');
                list.innerHTML = '';
                document.getElementById('currentPathDisplay').innerText = browserCurrentPath;
                
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const d = document.createElement('div');
                        d.className = 'dir-item';
                        const icon = item.name === '..' ? 'fa-arrow-left' : 'fa-folder';
                        d.innerHTML = `<i class="fas ${icon} text-warning"></i> ${item.name}`;
                        d.onclick = () => loadDirectory(item.path);
                        list.appendChild(d);
                    });
                } else {
                    list.innerHTML = `<div class="text-center p-5 text-muted">
                        <i class="fas fa-search mb-3 d-block" style="font-size: 2rem; opacity: 0.3;"></i>
                        No subdirectories found in current path.
                    </div>`;
                }
            } catch (e) {
                console.error("Directory browse error:", e);
                const list = document.getElementById('dirListing');
                list.innerHTML = `<div class="alert alert-danger m-4">
                    <strong>Error:</strong> Failed to load folder contents.<br>
                    <small>${e.message}</small>
                </div>`;
                throw e;
            }
        }

        function closeBrowser() { 
            document.getElementById('browseModal').style.display = 'none'; 
            document.body.style.overflow = 'auto';
        }

        function goUp() {
            const parts = browserCurrentPath.split('/').filter(p => p.length > 0);
            if (parts.length > 0) {
                parts.pop();
                loadDirectory('/' + parts.join('/'));
            } else {
                loadDirectory('/');
            }
        }

        function selectCurrentDir() {
            if (currentTargetId) {
                document.getElementById(currentTargetId).value = browserCurrentPath;
            }
            closeBrowser();
        }

        function updateOptPreview(el) {
            const container = el.closest('.border');
            const previewEl = container.querySelector('.opt-preview');
            if (!previewEl) return;

            let text = '';
            const flag = el.dataset.flag;

            if (el.classList.contains('dynamic-opt-bool')) {
                const isNegated = el.dataset.negated === 'true';
                const val = el.value; // 'enabled' or 'disabled'
                
                if (isNegated) {
                    // Negated flag (e.g. skip-bids): Disabled choice means ADD flag
                    text = (val === 'disabled') ? flag : '(omitted)';
                } else {
                    // Standard flag: Enabled choice means ADD flag
                    text = (val === 'enabled') ? flag : '(omitted)';
                }
            } else if (el.tagName === 'SELECT') {
                text = el.value ? `${flag} ${el.value}` : '(default)';
            } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                const val = el.value.trim();
                text = val ? `${flag} ${val.split(/[\s\n]+/)[0]}${val.includes(' ') || val.includes('\n') ? ' ...' : ''}` : '(empty)';
            }

            previewEl.innerText = text;
            previewEl.classList.toggle('bg-primary', text !== '(omitted)' && text !== '(default)' && text !== '(empty)');
            previewEl.classList.toggle('bg-secondary', text === '(omitted)' || text === '(default)' || text === '(empty)');
            previewEl.style.opacity = (text === '(omitted)' || text === '(default)' || text === '(empty)') ? '0.5' : '1';
        }

        function toggleEngineFields() {
            const engine = document.getElementById('container_engine').value;
            const folderGroup = document.getElementById('container_folder_group');
            const selectGroup = document.getElementById('container_select_group');
            const inputGroup = document.getElementById('container_input_group');
            const selectLabel = document.getElementById('container_select_label');

            if (engine === 'docker') {
                folderGroup.style.display = 'none';
                selectGroup.style.display = 'none';
                inputGroup.style.display = 'flex';
                selectLabel.innerText = 'Docker Image Name';
            } else {
                folderGroup.style.display = 'block';
                selectGroup.style.display = 'flex';
                inputGroup.style.display = 'none';
                selectLabel.innerText = 'Select App Image';
            }
        }

        async function scanContainers() {
            const f = document.getElementById('container_folder').value;
            if (!f) {
                showStatus("Please specify the containers folder first.", true);
                return;
            }
            try {
                const resp = await fetch('/list_containers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder: f }) });
                const data = await resp.json();
                if (data.error) { showStatus(data.error, true); return; }
                
                const s = document.getElementById('container_select');
                s.innerHTML = '';
                if (data.containers && data.containers.length > 0) {
                    data.containers.forEach(c => s.add(new Option(c, c)));
                    checkAppVersion();
                    document.getElementById('fetchHelpBtn').style.display = 'block';
                } else {
                    showStatus("No containers (.sif/.simg) found in that folder.", true);
                }
            } catch (e) {
                console.error("Scan error:", e);
                showStatus("Failed to scan containers.", true);
            }
        }

        async function fetchAppOptions() {
            const engine = document.getElementById('container_engine').value;
            let container;
            if (engine === 'docker') {
                container = document.getElementById('container_input').value.trim();
            } else {
                const f = document.getElementById('container_folder').value;
                const c = document.getElementById('container_select').value;
                if (!c) return;
                container = f + '/' + c;
            }
            if (!container) return;

            // Per-app defaults for boolean flags.
            // These defaults apply only to dynamically-discovered (help-parsed) options.
            const defaultCheckedFlags = new Set();
            if (container.toLowerCase().includes('fmriprep')) {
                // fMRIPrep: do not run FreeSurfer recon-all unless explicitly requested.
                defaultCheckedFlags.add('--fs-no-reconall');
            }

            const containerEl = document.getElementById('optionsContainer');
            document.getElementById('dynamicOptionsSection').style.display = 'block';
            containerEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Analyzing container...</div></div>';
            
            try {
                if (engine === 'apptainer') checkAppVersion();
                const resp = await fetch('/get_app_help', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ container: container, container_engine: engine }) 
                });
                const data = await resp.json();
                
                if (data.error) {
                    containerEl.innerHTML = `<div class="alert alert-warning m-4">Error fetching help: ${data.error}</div>`;
                    return;
                }

                if (data.app_info) document.getElementById('docLink').href = data.app_info.url;
                containerEl.innerHTML = '';
                
                if (data.sections && data.sections.length > 0) {
                    data.sections.forEach((sec, idx) => {
                        const secDiv = document.createElement('div');
                        secDiv.className = 'opt-section' + (idx === 0 ? ' active' : '');
                        const h = document.createElement('div');
                        h.className = 'opt-section-header';
                        h.innerHTML = `<span>${sec.title}</span><i class="fas fa-caret-down"></i>`;
                        h.onclick = () => {
                            secDiv.classList.toggle('active');
                        };
                        const content = document.createElement('div');
                        content.className = 'opt-section-content';
                        sec.options.forEach(opt => {
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded bg-light d-flex flex-column';
                            let input = '';
                            let previewStr = '';

                            if (opt.choices && opt.choices.length > 0) {
                                if (opt.is_multiple) {
                                    let chks = '';
                                    opt.choices.forEach(ch => {
                                        chks += `<div class="form-check"><input type="checkbox" class="form-check-input dynamic-opt-multi" data-flag="${opt.flag}" value="${ch}"> <label class="form-check-label">${ch}</label></div>`;
                                    });
                                    input = `<label class="form-label">${opt.name}</label><div style="max-height:120px;overflow:auto;border:1px solid #dee2e6;padding:10px;background:white;border-radius:6px;">${chks}</div>`;
                                } else {
                                    let opts = '<option value="">-- Default --</option>';
                                    opt.choices.forEach(ch => opts += `<option value="${ch}">${ch}</option>`);
                                    input = `<label class="form-label">${opt.name}</label><select class="dynamic-opt form-select" data-flag="${opt.flag}" onchange="updateOptPreview(this)">${opts}</select>`;
                                }
                            } else if (opt.has_value) {
                                if (opt.is_multiple) {
                                    input = `<label class="form-label">${opt.name}</label><textarea class="dynamic-opt form-control" data-flag="${opt.flag}" placeholder="Enter values (one per line)" oninput="updateOptPreview(this)"></textarea>`;
                                } else {
                                    input = `<label class="form-label">${opt.name}</label><input type="text" class="dynamic-opt form-control" data-flag="${opt.flag}" oninput="updateOptPreview(this)">`;
                                }
                            } else {
                                // Boolean Flag: use Enabled/Disabled toggle for clarity
                                const isDefaultChecked = defaultCheckedFlags.has(opt.flag);
                                // For negated flags, "Checked" (Disabled) usually means adding the flag.
                                // Logic: 
                                //   Standard: Enabled (no flag) | Disabled (not possible usually unless default is on, but we follow standard CLI)
                                //   Actually, let's keep it simple: 
                                //   If standard flag: Enabled -> add flag, Disabled -> omit.
                                //   If negated flag: Enabled -> omit flag, Disabled -> add flag.
                                
                                let options = '';
                                if (opt.is_negated) {
                                    // Default (Enabled) is "no flag", Disabled is "add flag"
                                    options = `<option value="enabled"${!isDefaultChecked ? ' selected' : ''}>Enabled</option>
                                               <option value="disabled"${isDefaultChecked ? ' selected' : ''}>Disabled</option>`;
                                } else {
                                    // Default (Disabled) is "no flag", Enabled is "add flag"
                                    options = `<option value="disabled"${!isDefaultChecked ? ' selected' : ''}>Disabled</option>
                                               <option value="enabled"${isDefaultChecked ? ' selected' : ''}>Enabled</option>`;
                                }
                                
                                input = `<label class="form-label">${opt.name}</label>
                                         <select class="dynamic-opt-bool form-select" data-flag="${opt.flag}" data-negated="${opt.is_negated}" onchange="updateOptPreview(this)">
                                            ${options}
                                         </select>`;
                            }
                            
                            const desc = opt.description ? `<div style="font-size:0.7rem;color:#777;margin-top:10px;line-height:1.4;border-top:1px solid #eee;padding-top:8px;">${opt.description}</div>` : '';
                            const preview = `<div class="mt-2"><span class="badge bg-secondary opacity-50 font-monospace opt-preview" style="font-size:0.65rem;"></span></div>`;
                            
                            item.innerHTML = input + preview + desc;
                            content.appendChild(item);
                            
                            // Initialize preview
                            const selectEl = item.querySelector('.dynamic-opt, .dynamic-opt-bool, .dynamic-opt-multi, input, textarea');
                            if (selectEl) updateOptPreview(selectEl);
                        });
                        secDiv.appendChild(h); secDiv.appendChild(content); containerEl.appendChild(secDiv);
                    });
                } else {
                    let msg = '<div class="text-center p-4">No specific options detected for this container.</div>';
                    if (data.raw_help) {
                        msg += `<div class="mt-3"><button class="btn btn-sm btn-outline-secondary" onclick="this.nextElementSibling.style.display='block'; this.style.display='none'">Show Raw Help Output</button>
                               <pre style="display:none; text-align:left; font-size:0.7rem; background:#f8f9fa; padding:15px; margin-top:10px; border:1px solid #eee; border-radius:5px; max-height:300px; overflow:auto;">${data.raw_help}</pre></div>`;
                    }
                    containerEl.innerHTML = msg;
                }
            } catch (e) {
                containerEl.innerHTML = `<div class="alert alert-danger m-4">Connection error. Could not retrieve container help.</div>`;
            }
        }

        async function handleSaveAndRun(shouldRun) {
            const opts = [];
            // Handle standard inputs
            document.querySelectorAll('.dynamic-opt').forEach(el => {
                if (el.type === 'checkbox') { 
                    if (el.checked) opts.push(el.dataset.flag); 
                } else if (el.value.trim()) {
                    opts.push(el.dataset.flag);
                    if (el.tagName === 'TEXTAREA') {
                        // Split by newlines or spaces for multiple values
                        const vals = el.value.trim().split(/[\s\n]+/);
                        vals.forEach(v => { if(v) opts.push(v); });
                    } else {
                        opts.push(el.value.trim());
                    }
                }
            });

            // Handle Boolean selection (Enabled/Disabled)
            document.querySelectorAll('.dynamic-opt-bool').forEach(el => {
                const flag = el.dataset.flag;
                const isNegated = el.dataset.negated === 'true';
                const val = el.value; // 'enabled' or 'disabled'

                if (isNegated) {
                    // For negated flag, "Disabled" means we add the skip/no flag
                    if (val === 'disabled') opts.push(flag);
                } else {
                    // For standard flag, "Enabled" means we add it
                    if (val === 'enabled') opts.push(flag);
                }
            });

            const multi = {};
            document.querySelectorAll('.dynamic-opt-multi').forEach(el => {
                if (el.checked) { const f = el.dataset.flag; if (!multi[f]) multi[f] = []; multi[f].push(el.value); }
            });
            for (const f in multi) { opts.push(f); multi[f].forEach(v => opts.push(v)); }
            
            // Add custom arguments from the textarea
            const customArgsVal = document.getElementById('custom_args').value.trim();
            if (customArgsVal) {
                // Split by spaces but respect quotes would be better, but simple split for now
                const args = customArgsVal.split(/[\s\n]+/);
                args.forEach(a => { if(a) opts.push(a); });
            }

            const mounts = [];
            document.getElementById('custom_mounts').value.split('\n').forEach(line => {
                const parts = line.trim().split(':');
                if (parts.length >= 2) {
                    mounts.push({ source: parts[0].trim(), target: parts.slice(1).join(':').trim() });
                }
            });

            const engine = document.getElementById('container_engine').value;
            let containerPath;
            if (engine === 'docker') {
                containerPath = document.getElementById('container_input').value.trim();
            } else {
                containerPath = document.getElementById('container_folder').value + '/' + document.getElementById('container_select').value;
            }

            const config = {
                common: {
                    bids_folder: document.getElementById('bids_folder').value,
                    output_folder: document.getElementById('output_folder').value,
                    tmp_folder: document.getElementById('tmp_folder').value,
                    templateflow_dir: document.getElementById('templateflow_dir').value,
                    container_engine: engine,
                    container: containerPath,
                    jobs: parseInt(document.getElementById('jobs').value) || 1
                },
                app: { 
                    analysis_level: document.getElementById('analysis_level').value, 
                    options: opts,
                    mounts: mounts 
                }
            };

            const filename = document.getElementById('config_name').value || 'config.json';
            try {
                const resp = await fetch('/save_config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename, config }) });
                const resData = await resp.json();
                if (resData.message) {
                    lastSavedPath = resData.path;
                    showStatus(resData.message);
                    if (shouldRun) executeNow();
                    else document.getElementById('runApp').style.display = 'inline-block';
                } else {
                    showStatus(resData.error, true);
                }
            } catch (e) {
                showStatus("Failed to save config: " + e.message, true);
            }
        }

        async function executeNow() {
            if (!lastSavedPath) {
                showStatus("No config file ready. Please save first.", true);
                return;
            }
            const r_args = [];
            document.querySelectorAll('.runner-opt').forEach(el => {
                const flag = el.dataset.flag;
                if (el.type === 'checkbox') { if (el.checked) r_args.push(flag); }
                else if (el.value.trim()) { r_args.push(flag); r_args.push(el.value.trim()); }
            });

            showStatus("🚀 Starting BIDS App Runner...");
            try {
                const resp = await fetch('/run_app', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_path: lastSavedPath, runner_args: r_args }) });
                const data = await resp.json();
                if (data.message) {
                    showStatus(data.message);
                    initialLoad = false;
                } else {
                    showStatus(data.error + (data.details ? ": " + data.details : ""), true);
                }
            } catch (e) {
                showStatus("Execution request failed: " + e.message, true);
            }
        }

        async function killApp() {
            if (!confirm("Are you sure you want to terminate all runner processes and containers?")) return;
            try {
                const resp = await fetch('/kill_job', { method: 'POST' });
                const data = await resp.json();
                showStatus(data.message || data.error, !!data.error);
            } catch (e) {
                showStatus("Failed to send stop signal.", true);
            }
        }

        function showStatus(msg, isError=false) {
            const el = document.getElementById('statusAlert');
            el.innerText = msg; el.style.display = 'block';
            el.style.background = isError ? '#fff5f5' : '#ebfbee';
            el.style.color = isError ? '#e03131' : '#2f9e44';
            el.style.border = `1px solid ${isError ? '#ffa8a8' : '#b2f2bb'}`;
            setTimeout(() => el.style.display = 'none', 8000);
        }

        async function loadExistingConfig() {
            console.log("Loading existing configurations...");
            try {
                const resp = await fetch('/list_configs');
                if (!resp.ok) throw new Error("Failed to list configs");
                const data = await resp.json();
                
                const list = document.getElementById('configList');
                list.innerHTML = '';
                
                if (data.configs && data.configs.length > 0) {
                    data.configs.forEach(cfg => {
                        const d = document.createElement('div');
                        d.className = 'dir-item';
                        d.innerHTML = `<i class="fas fa-file-code text-primary"></i> ${cfg}`;
                        d.onclick = () => loadConfigDetails(cfg);
                        list.appendChild(d);
                    });
                } else {
                    list.innerHTML = '<div class="p-4 text-center text-muted">No configuration files found.</div>';
                }
                
                document.getElementById('configModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            } catch (e) {
                console.error("loadExistingConfig error:", e);
                showStatus("Error loading configurations: " + e.message, true);
            }
        }

        async function loadConfigDetails(filename) {
            console.log("Loading details for:", filename);
            document.getElementById('configModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            try {
                const resp = await fetch(`/get_config?name=${encodeURIComponent(filename)}`);
                const data = await resp.json();
                const cfg = data.config;
                
                document.getElementById('bids_folder').value = cfg.common.bids_folder || '';
                document.getElementById('output_folder').value = cfg.common.output_folder || '';
                document.getElementById('tmp_folder').value = cfg.common.tmp_folder || '';
                document.getElementById('templateflow_dir').value = cfg.common.templateflow_dir || '';
                document.getElementById('jobs').value = cfg.common.jobs || 1;
                document.getElementById('analysis_level').value = cfg.app.analysis_level || 'participant';
                document.getElementById('config_name').value = filename;
                
                lastSavedPath = `/data/local/software/bids_apps_runner/configs/${filename}`;
                document.getElementById('runApp').style.display = 'inline-block';

                const engine = cfg.common.container_engine || 'apptainer';
                document.getElementById('container_engine').value = engine;
                toggleEngineFields();

                const containerPath = cfg.common.container;
                if (containerPath) {
                    if (engine === 'docker') {
                        document.getElementById('container_input').value = containerPath;
                        console.log("Auto-fetching help for Docker image...");
                        await fetchAppOptions();
                    } else {
                        const idx = containerPath.lastIndexOf('/');
                        if (idx !== -1) {
                            const folder = containerPath.substring(0, idx);
                            const name = containerPath.substring(idx + 1);
                            document.getElementById('container_folder').value = folder;
                            await scanContainers();
                            
                            // If the container from config is not in the select (e.g. renamed or moved), add it
                            const s = document.getElementById('container_select');
                            let exists = Array.from(s.options).some(o => o.value === name);
                            if (!exists) {
                                s.add(new Option(name + " (not in folder)", name));
                            }
                            s.value = name;
                            
                            console.log("Auto-fetching help for loaded container...");
                            await fetchAppOptions();
                        }
                    }
                }
                
                // Rest of the options parsing...
                const options = cfg.app.options || [];
                        const unhandledArgs = [];
                        for (let i = 0; i < options.length; i++) {
                            const opt = options[i];
                            const el = document.querySelector(`[data-flag="${opt}"]`);
                            if (!el) {
                                const multiEls = document.querySelectorAll(`.dynamic-opt-multi[data-flag="${opt}"]`);
                                if (multiEls.length > 0) {
                                    while (i + 1 < options.length && !options[i+1].startsWith('-')) {
                                        i++;
                                        const val = options[i];
                                        document.querySelectorAll(`.dynamic-opt-multi[data-flag="${opt}"][value="${val}"]`).forEach(checkedEl => checkedEl.checked = true);
                                    }
                                } else {
                                    // Not found in dynamic UI, move to custom args
                                    if (opt.startsWith('-')) {
                                        unhandledArgs.push(opt);
                                        while (i + 1 < options.length && !options[i+1].startsWith('-')) {
                                            i++;
                                            unhandledArgs.push(options[i]);
                                        }
                                    }
                                }
                                continue;
                            }

                            if (el.classList.contains('dynamic-opt-bool')) {
                                // Logic: If the flag is PRESENT in config:
                                //   Standard: Enabled (sets flag)
                                //   Negated: Disabled (sets skip- flag)
                                const isNegated = el.dataset.negated === 'true';
                                el.value = isNegated ? 'disabled' : 'enabled';
                            } else if (el.type === 'checkbox') {
                                el.checked = true;
                            } else {
                                if (i + 1 < options.length && !options[i+1].startsWith('-')) {
                                    if (el.tagName === 'TEXTAREA') {
                                        const vals = [];
                                        while (i + 1 < options.length && !options[i+1].startsWith('-')) {
                                            i++;
                                            vals.push(options[i]);
                                        }
                                        el.value = vals.join('\n');
                                    } else {
                                        el.value = options[i+1];
                                        i++;
                                    }
                                }
                            }
                            if (typeof updateOptPreview === 'function') updateOptPreview(el);
                        }
                        document.getElementById('custom_args').value = unhandledArgs.join(' ');
                    }
                }
                
                // Load mounts
                if (cfg.app.mounts) {
                    const mountLines = cfg.app.mounts.map(m => `${m.source}:${m.target}`);
                    document.getElementById('custom_mounts').value = mountLines.join('\n');
                }

                showStatus("Configuration loaded: " + filename);
            } catch (e) {
                console.error("loadConfigDetails error:", e);
                showStatus("Failed to load config details.", true);
            }
        }

        function switchTab(tabId, button) {
            document.querySelectorAll('.tab-panel').forEach(panel => panel.style.display = 'none');
            const panel = document.getElementById(tabId);
            if (panel) {
                panel.style.display = 'block';
                
                // Sync fields between tabs if empty
                if (tabId === 'checkTab') {
                    if (!document.getElementById('validation_bids_folder').value && document.getElementById('bids_folder').value) {
                        document.getElementById('validation_bids_folder').value = document.getElementById('bids_folder').value;
                    }
                    if (!document.getElementById('validation_derivatives_folder').value && document.getElementById('output_folder').value) {
                        document.getElementById('validation_derivatives_folder').value = document.getElementById('output_folder').value;
                    }
                } else if (tabId === 'buildTab') {
                    if (!document.getElementById('build_output_dir').value && document.getElementById('container_folder').value) {
                        document.getElementById('build_output_dir').value = document.getElementById('container_folder').value;
                    }
                    if (!document.getElementById('build_tmp_dir').value && document.getElementById('tmp_folder').value) {
                        document.getElementById('build_tmp_dir').value = document.getElementById('tmp_folder').value;
                    }
                }
            }
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.remove('active');
                btn.classList.add('btn-outline-primary');
            });
            if (button) {
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-primary');
                button.classList.add('active');
            }
        }

        function _setUtilityStatus(element, message, isError=false) {
            if (!element) return;
            if (!message) {
                element.style.display = 'none';
                return;
            }
            element.style.display = 'block';
            element.innerText = message;
            element.style.background = isError ? '#fff5f5' : '#eef4ff';
            element.style.color = isError ? '#c92a2a' : '#1f3d7a';
            element.style.border = `1px solid ${isError ? '#f5c2c7' : '#b6d4fe'}`;
        }

        async function runOutputCheck() {
            const statusEl = document.getElementById('validationStatusBox');
            const logEl = document.getElementById('validationOutput');
            const btn = document.getElementById('runValidationBtn');
            const bids = document.getElementById('validation_bids_folder').value.trim();
            const deriv = document.getElementById('validation_derivatives_folder').value.trim();
            if (!bids || !deriv) {
                _setUtilityStatus(statusEl, 'Provide both the BIDS dataset and derivatives folders.', true);
                return;
            }
            btn.disabled = true;
            btn.innerText = 'Running...';
            _setUtilityStatus(statusEl, 'Running validation...', false);
            const resDiv = document.getElementById('validationDetailsResults');
            if (resDiv) resDiv.innerHTML = '';
            try {
                const resp = await fetch('/run_output_check', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        bids_dir: bids,
                        derivatives_dir: deriv,
                        pipeline: document.getElementById('validation_pipeline').value,
                        verbose: document.getElementById('validation_verbose').checked,
                        quiet: document.getElementById('validation_quiet').checked,
                        list_missing: document.getElementById('validation_missing_only').checked
                    })
                });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    _setUtilityStatus(statusEl, data.error || 'Validation failed.', true);
                } else {
                    const summary = data.parsed?.summary;
                    const pipelines = data.parsed?.pipelines || {};
                    const message = summary ? `Checked ${summary.total_pipelines} pipeline(s), failed: ${summary.failed}.` : 'Validation completed';
                    _setUtilityStatus(statusEl, message, !data.success);
                    
                        // Detailed results rendering
                    if (data.parsed && data.parsed.pipelines) {
                        const missingSubjects = new Set();
                        let hasResults = false;
                        
                        // Check if we have any successful pipeline that might have reports
                        for (const [p, res] of Object.entries(data.parsed.pipelines)) {
                            if (res.status === 'passed' || res.total_missing < 10) hasResults = true; 
                        }
                        
                        if (hasResults) {
                            const btn = document.getElementById('viewReportsBtn');
                            if (btn) btn.style.display = 'block';
                        }
                        let html = `<div class="mt-3 p-3 border rounded bg-white shadow-sm">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                        <h6 class="mb-0 fw-bold"><i class="fas fa-stethoscope me-1 text-primary"></i> Validation Health Report</h6>
                                        <div class="d-flex gap-2">
                                            <button id="viewReportsBtn" class="btn btn-sm btn-outline-info" style="display:none;" onclick="loadReportsList()">View HTML Reports</button>
                                            <button id="useMissingBtn" class="btn btn-sm btn-outline-warning" style="display:none;" onclick="applyMissingToRunner()">Use Missing Subjects in Runner</button>
                                        </div>
                                    </div>
                                    
                                    <div id="validationSummaryBar" class="mb-4">
                                        <div class="d-flex justify-content-between small fw-bold mb-1">
                                            <span>GLOBAL DATA COMPLETENESS</span>
                                            <span id="globalCompletnessPct">0%</span>
                                        </div>
                                        <div class="progress shadow-sm" style="height: 20px; background-color: #e9ecef;">
                                            <div id="globalProgressBarFound" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">Found</div>
                                            <div id="globalProgressBarMissing" class="progress-bar bg-danger" role="progressbar" style="width: 0%">Missing</div>
                                        </div>
                                    </div>
                                    
                                    <div id="subjectGallery" class="mb-4">
                                        <div class="small fw-bold text-muted mb-2 uppercase" style="font-size: 0.7rem;">Subject Status Grid</div>
                                        <div id="subjectGrid" class="d-flex flex-wrap gap-1" style="max-height: 200px; overflow-y: auto; padding: 5px; background: #f8f9fa; border-radius: 4px; border: 1px inset #eee;">
                                            <!-- Grid populated dynamically -->
                                        </div>
                                        <div class="mt-2 d-flex gap-3 small">
                                            <span><span class="badge bg-success" style="width:12px; height:12px; padding:0;">&nbsp;</span> All Passed</span>
                                            <span><span class="badge bg-danger" style="width:12px; height:12px; padding:0;">&nbsp;</span> Issues Found</span>
                                            <span><span class="badge bg-secondary" style="width:12px; height:12px; padding:0;">&nbsp;</span> Not Validated</span>
                                        </div>
                                    </div>

                                    <ul class="list-group list-group-flush">`;
                        for (const [p, res] of Object.entries(data.parsed.pipelines)) {
                            const statusCls = res.status === 'passed' ? 'text-success' : 'text-danger';
                            const icon = res.status === 'passed' ? 'fa-check-circle' : 'fa-times-circle';
                            html += `<li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="fas ${icon} ${statusCls} me-2"></i><strong>${p.toUpperCase()}</strong></span>
                                            <span class="badge ${res.status === 'passed' ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                ${res.missing_items ? res.missing_items.length : 0} missing
                                            </span>
                                        </div>`;
                            
                            // Pipeline Metadata Badge
                            if (res.stats && res.stats.metadata) {
                                const m = res.stats.metadata;
                                if (m.tool !== 'Unknown' || m.version !== 'Unknown') {
                                    html += `<div class="mt-1 mb-2 d-flex flex-wrap gap-1 align-items-center">
                                                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill small" title="${m.description}">
                                                    <i class="fas fa-tag me-1"></i>${m.tool} v${m.version}
                                                </span>
                                                <span class="badge bg-light text-muted border rounded-pill small">
                                                    BIDS ${m.bids_version}
                                                </span>
                                                ${m.env ? `<span class="badge bg-info-subtle text-info border border-info-subtle rounded-pill small"><i class="fas fa-microchip me-1"></i>${m.env}</span>` : ''}
                                                ${m.settings ? `<small class="text-muted ms-1" style="font-size: 0.7rem;" title="${m.settings}"><i class="fas fa-cog me-1"></i>${m.settings.length > 50 ? m.settings.substring(0, 50) + '...' : m.settings}</small>` : ''}
                                             </div>`;
                                }
                            }
                            
                            // Render Statistics if available
                            if (res.stats && Object.keys(res.stats).length > 0) {
                                html += `<div class="mt-2 p-2 bg-light border-start border-primary border-4 rounded">
                                            <h6 class="small fw-bold text-primary mb-2"><i class="fas fa-chart-bar me-1"></i> Pipeline Metrics</h6>
                                            <div class="row g-2 text-center">
                                                <div class="col-4">
                                                    <div class="border rounded bg-white p-1">
                                                        <div class="small text-muted">Total</div>
                                                        <div class="fw-bold">${res.stats.total_subjects || 0}</div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="border rounded bg-white p-1">
                                                        <div class="small text-muted">Ready</div>
                                                        <div class="fw-bold text-success">${(res.stats.subjects_with_dwi || res.stats.subjects_with_bold || res.stats.subjects_with_segmentation || res.stats.subjects_with_reports || 0)}</div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="border rounded bg-white p-1">
                                                        <div class="small text-muted">Issues</div>
                                                        <div class="fw-bold text-danger">${(res.stats.subjects_failed ? res.stats.subjects_failed.length : 0) || (res.stats.subjects_with_no_dwi ? res.stats.subjects_with_no_dwi.length : (res.stats.subjects_with_no_bold ? res.stats.subjects_with_no_bold.length : 0))}</div>
                                                    </div>
                                                </div>
                                            </div>`;
                                
                                // CAT12 specific detailed stats
                                if (p === 'cat12' && res.stats.subjects_failed && res.stats.subjects_failed.length > 0) {
                                    html += `<div class="mt-2 small text-danger"><i class="fas fa-exclamation-circle me-1"></i> ${res.stats.subjects_failed.length} subjects have explicit failure markers.</div>`;
                                }

                                // Session level stats
                                if (res.stats.session_statistics) {
                                    html += `<div class="mt-2 small">
                                                <table class="table table-sm table-bordered bg-white mb-0" style="font-size: 0.8rem;">
                                                    <thead class="table-light">
                                                        <tr><th>Session</th><th>Found</th><th>Missing</th></tr>
                                                    </thead>
                                                    <tbody>`;
                                    for (const [sess, sdata] of Object.entries(res.stats.session_statistics)) {
                                        const missingCount = sdata.missing_subjects ? sdata.missing_subjects.length : 0;
                                        html += `<tr>
                                                    <td class="fw-bold">${sess}</td>
                                                    <td>${sdata.total_subjects}</td>
                                                    <td class="${missingCount > 0 ? 'text-danger fw-bold' : 'text-success'}">${missingCount}</td>
                                                 </tr>`;
                                    }
                                    html += `</tbody></table></div>`;
                                }
                                
                                // Missing subjects with DWI but no output?
                                if (res.stats.subjects_with_missing_sessions && res.stats.subjects_with_missing_sessions.length > 0) {
                                    html += `<div class="mt-2 small text-danger"><i class="fas fa-exclamation-triangle me-1"></i> ${res.stats.subjects_with_missing_sessions.length} subjects have coverage issues.</div>`;
                                }
                                
                                // QSIRecon specific detailed stats
                                if (p === 'qsirecon' && res.stats.recon_pipelines_found) {
                                    html += `<div class="mt-2 small border-top pt-2">
                                                <div class="fw-bold mb-1 text-secondary">Reconstruction Pipelines:</div>`;
                                    res.stats.recon_pipelines_found.forEach(rp => {
                                        const found = (res.stats.subjects_by_pipeline && res.stats.subjects_by_pipeline[rp]) ? res.stats.subjects_by_pipeline[rp].length : 0;
                                        const total = res.stats.subjects_with_dwi || 0;
                                        const pct = total > 0 ? Math.round((found/total)*100) : 0;
                                        html += `<div class="mb-1">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span>${rp}</span>
                                                        <span>${found}/${total} subjects</span>
                                                    </div>
                                                    <div class="progress" style="height: 6px;">
                                                        <div class="progress-bar ${pct === 100 ? 'bg-success' : 'bg-warning'}" role="progressbar" style="width: ${pct}%"></div>
                                                    </div>
                                                 </div>`;
                                    });
                                    html += `</div>`;
                                }

                                html += `</div>`;
                            }

                            /* Analysis Log Health */
                            if (res.stats && res.stats.log_stats && (res.stats.log_stats.errors > 0 || res.stats.log_stats.warnings > 0)) {
                                const ls = res.stats.log_stats;
                                html += `<div class="mt-2 p-2 bg-white border rounded shadow-sm">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <h6 class="small fw-bold mb-0"><i class="fas fa-file-medical-alt me-1 text-primary"></i> Analysis Log Health</h6>
                                                <div>
                                                    ${ls.errors > 0 ? `<span class="badge bg-danger me-1" title="Critical issues detected in logs">${ls.errors} Errors</span>` : ''}
                                                    ${ls.warnings > 0 ? `<span class="badge bg-warning text-dark" title="Non-critical warnings in logs">${ls.warnings} Warnings</span>` : ''}
                                                </div>
                                            </div>`;
                                
                                if (ls.error_list && ls.error_list.length > 0) {
                                    html += `<div class="mb-2">
                                                <div class="small fw-bold text-danger mb-1" style="font-size: 0.65rem;">CRITICAL LOG ENTRIES:</div>
                                                <div class="p-1 bg-danger-subtle border border-danger-subtle rounded small overflow-auto" style="max-height: 120px; font-family: 'Courier New', Courier, monospace; font-size: 0.65rem; line-height: 1.2;">
                                                    ${ls.error_list.map(e => `<div class="border-bottom border-danger-subtle py-1 text-danger-emphasis">${e}</div>`).join('')}
                                                </div>
                                             </div>`;
                                }
                                
                                if (ls.warning_list && ls.warning_list.length > 0) {
                                    html += `<div>
                                                <div class="small fw-bold text-warning-emphasis mb-1" style="font-size: 0.65rem;">NOTABLE WARNINGS:</div>
                                                <div class="p-1 bg-warning-subtle border border-warning-subtle rounded small overflow-auto" style="max-height: 120px; font-family: 'Courier New', Courier, monospace; font-size: 0.65rem; line-height: 1.2;">
                                                    ${ls.warning_list.map(w => `<div class="border-bottom border-warning-subtle py-1 text-dark">${w}</div>`).join('')}
                                                </div>
                                             </div>`;
                                }
                                
                                html += `</div>`;
                            }

                            if (res.missing_items && res.missing_items.length > 0) {
                                html += `<div class="mt-2 p-2 border rounded bg-white"><small class="text-muted d-block mb-1">Detailed Failures:</small><small class="text-muted">`;
                                res.missing_items.forEach(m => {
                                    const match = m.match(/sub-\w+/);
                                    if (match) missingSubjects.add(match[0]);
                                });
                                // User requested clustered IDs in text, but here we can show grouped summaries if possible
                                // For now, just keep a cleaner version of the items
                                res.missing_items.slice(0, 8).forEach(m => {
                                    const firstLine = m.split('\n')[0].trim();
                                    html += `<div class="mb-1 pb-1 border-bottom-dotted border-secondary" style="border-bottom: 1px dotted #ccc;">- ${firstLine}</div>`;
                                });
                                if (res.missing_items.length > 8) html += `<div class="text-center">... and ${res.missing_items.length - 8} more issues</div>`;
                                html += `</small></div>`;
                            }
                            html += `</li>`;
                        }
                        html += `</ul></div>`;
                        
                        document.getElementById('validationDetailsResults').innerHTML = html;
                        
                        // Populate Status Grid
                        const grid = document.getElementById('subjectGrid');
                        if (grid) {
                            grid.innerHTML = '';
                            const allSubjs = new Set();
                            const failedSubjs = new Set();
                            
                            // Collect from pipelines
                            for (const [p, res] of Object.entries(data.parsed.pipelines)) {
                                if (res.stats && res.stats.all_subjects_list) {
                                    res.stats.all_subjects_list.forEach(s => allSubjs.add(s));
                                }
                                if (res.missing_items) {
                                    res.missing_items.forEach(m => {
                                        const match = m.match(/sub-\w+/);
                                        if (match) {
                                            failedSubjs.add(match[0]);
                                            allSubjs.add(match[0]);
                                        }
                                    });
                                }
                            }
                            
                            console.log("Subject Grid Population:", { 
                                pipelines: Object.keys(data.parsed.pipelines), 
                                totalUniqueSubjects: allSubjs.size,
                                failedCount: failedSubjs.size
                            });

                            if (allSubjs.size > 0) {
                                const allCount = allSubjs.size;
                                const failedCount = failedSubjs.size;
                                const passedCount = allCount - failedCount;
                                const pct = Math.round((passedCount / allCount) * 100);
                                
                                document.getElementById('globalCompletnessPct').innerText = `${pct}% (${passedCount}/${allCount})`;
                                document.getElementById('globalProgressBarFound').style.width = `${pct}%`;
                                document.getElementById('globalProgressBarMissing').style.width = `${100-pct}%`;
                                
                                Array.from(allSubjs).sort().forEach(s => {
                                    const isFailed = failedSubjs.has(s);
                                    const box = document.createElement('span');
                                    box.className = `badge ${isFailed ? 'bg-danger' : 'bg-success'}`;
                                    box.style.width = '14px';
                                    box.style.display = 'inline-block';
                                    box.style.height = '14px';
                                    box.style.padding = '0';
                                    box.style.borderRadius = '2px';
                                    box.style.cursor = 'help';
                                    box.title = s + (isFailed ? ' - Issues Found' : ' - Passed');
                                    box.innerHTML = '&nbsp;';
                                    // Empty box, hover for Subject ID
                                    grid.appendChild(box);
                                });
                            } else {
                                grid.innerHTML = '<div class="text-muted small">No subjects identified for grid.</div>';
                            }
                        }

                        if (missingSubjects.size > 0) {
                            const btn = document.getElementById('useMissingBtn');
                            if (btn) {
                                btn.style.display = 'block';
                                btn.dataset.subjects = Array.from(missingSubjects).join(' ');
                            }
                        }
                        
                        // If parsing succeeded, hide the raw log by default but show the header
                        document.getElementById('validationLogHeader').style.display = 'block';
                        document.getElementById('validationOutput').style.display = 'none';
                        document.getElementById('logToggleText').innerText = 'Show Logs';
                    }
                }
                
                // Combine stderr and stdout for the log box, but prioritize stderr for human logs
                let logText = (data.stderr || "") + (data.stdout || "");
                
                // Filter out the JSON part from stdout if we parsed it successfully
                if (data.parsed && logText.includes('{') && logText.includes('}')) {
                    // Simple way to try to hide the JSON block from the visual console log if it was parsed
                    try {
                        const firstBrace = logText.indexOf('{');
                        const lastBrace = logText.lastIndexOf('}');
                        if (firstBrace !== -1 && lastBrace !== -1) {
                            logText = logText.substring(0, firstBrace) + "[JSON Results Parsed Above]\n" + logText.substring(lastBrace + 1);
                        }
                    } catch(e) {}
                }
                
                if (data.log_file) {
                    logText += (logText ? '\n\n' : '') + `Log saved at: ${data.log_file}`;
                }
                logEl.innerText = logText;
                
                // If it failed or was not parsed, always show logs
                if (!data.parsed) {
                    document.getElementById('validationLogHeader').style.display = 'block';
                    document.getElementById('validationOutput').style.display = 'block';
                    document.getElementById('logToggleText').innerText = 'Hide Logs';
                }
            } catch (err) {
                _setUtilityStatus(statusEl, 'Validation request failed: ' + err.message, true);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Run Validation';
            }
        }

        function clearValidationOutput() {
            document.getElementById('validationOutput').innerText = '';
            document.getElementById('validation_verbose').checked = false;
            _setUtilityStatus(document.getElementById('validationStatusBox'), '');
            const resDiv = document.getElementById('validationDetailsResults');
            if (resDiv) resDiv.innerHTML = '';
            document.getElementById('validationLogHeader').style.display = 'none';
            document.getElementById('validationOutput').style.display = 'block';
        }

        function toggleValidationLog() {
            const log = document.getElementById('validationOutput');
            const toggleText = document.getElementById('logToggleText');
            if (log.style.display === 'none') {
                log.style.display = 'block';
                toggleText.innerText = 'Hide Logs';
            } else {
                log.style.display = 'none';
                toggleText.innerText = 'Show Logs';
            }
        }

        function applyMissingToRunner() {
            const btn = document.getElementById('useMissingBtn');
            const subjects = btn.dataset.subjects;
            if (subjects) {
                document.getElementById('runner_subjects').value = subjects;
                switchTab('runnerTab', document.getElementById('tabRunnerBtn'));
                showStatus(`Applied ${subjects.split(' ').length} missing subjects to Runner filter.`);
            }
        }

        async function loadReportsList() {
            const deriv = document.getElementById('validation_derivatives_folder').value.trim();
            const pipeline = document.getElementById('validation_pipeline').value;
            
            _setUtilityStatus(document.getElementById('validationStatusBox'), 'Scanning for HTML reports...', false);
            try {
                const resp = await fetch('/list_reports', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ derivatives_dir: deriv, pipeline: pipeline })
                });
                const data = await resp.json();
                
                if (data.reports && data.reports.length > 0) {
                    document.getElementById('reportModal').style.display = 'block';
                    document.body.style.overflow = 'hidden';
                    
                    const list = document.getElementById('reportListItems');
                    list.innerHTML = '';
                    data.reports.forEach(r => {
                        const d = document.createElement('div');
                        d.className = 'p-2 border-bottom mb-1 rounded bg-white report-item';
                        d.style.cursor = 'pointer';
                        d.style.fontSize = '0.85rem';
                        d.onmouseover = () => d.style.background = '#eef7ff';
                        d.onmouseout = () => d.style.background = 'white';
                        d.innerHTML = `<i class="fas fa-file-alt text-info me-2"></i><strong>${r.subject}</strong><br><small class="text-muted">${r.name}</small>`;
                        d.onclick = () => {
                            document.querySelectorAll('.report-item').forEach(i => i.style.border = '1px solid #eee');
                            d.style.border = '2px solid var(--accent-color)';
                            openReport(r.path);
                        };
                        list.appendChild(d);
                    });
                     _setUtilityStatus(document.getElementById('validationStatusBox'), `Found ${data.reports.length} reports.`, false);
                } else {
                    _setUtilityStatus(document.getElementById('validationStatusBox'), 'No HTML reports found in derivatives.', true);
                }
            } catch (e) {
                console.error("Reports scan failed", e);
            }
        }

        function openReport(path) {
            document.getElementById('reportPlaceholder').style.display = 'none';
            document.getElementById('reportIframe').style.display = 'block';
            document.getElementById('reportIframe').src = `/view_report?path=${encodeURIComponent(path)}`;
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('reportIframe').src = 'about:blank';
            document.getElementById('reportPlaceholder').style.display = 'flex';
        }

        async function openTemplateFlowPicker() {
            const path = document.getElementById('templateflow_dir').value.trim();
            if (!path) {
                showStatus('Please set a TemplateFlow directory first.', true);
                return;
            }

            document.getElementById('tfModal').style.display = 'block';
            const list = document.getElementById('tfList');
            list.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Scanning TemplateFlow...</div></div>';

            try {
                const resp = await fetch('/get_templateflow_templates', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ path: path })
                });
                const data = await resp.json();

                if (data.templates && data.templates.length > 0) {
                    let html = '<div class="row g-3">';
                    data.templates.forEach(t => {
                        html += `
                            <div class="col-md-6">
                                <div class="p-3 border rounded bg-light h-100">
                                    <div class="fw-bold mb-2">${t.name}</div>
                                    <div class="d-flex flex-wrap gap-1">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input tf-sel" type="checkbox" data-tpl="${t.name}" value="${t.name}">
                                            <label class="form-check-label small">Default</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input tf-sel" type="checkbox" data-tpl="${t.name}" data-res="native" value="${t.name}:res-native">
                                            <label class="form-check-label small text-primary fw-bold">res-native</label>
                                        </div>
                                        ${t.resolutions.filter(r => r !== 'native').map(r => `
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input tf-sel" type="checkbox" data-tpl="${t.name}" data-res="${r}" value="${t.name}:res-${r}">
                                                <label class="form-check-label small">res-${r}</label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                    
                    // Add change listeners
                    document.querySelectorAll('.tf-sel').forEach(el => {
                        el.addEventListener('change', updateTFSummary);
                    });
                } else if (data.error) {
                    list.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    list.innerHTML = '<div class="alert alert-warning">No templates found in this directory. Templates must be in tpl-&lt;name&gt; folders.</div>';
                }
            } catch (err) {
                list.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            }
        }

        function updateTFSummary() {
            const sels = Array.from(document.querySelectorAll('.tf-sel:checked')).map(el => el.value);
            document.getElementById('tfSelectionSummary').innerText = sels.length > 0 ? `Selected: ${sels.join(', ')}` : '';
        }

        function applyTFSelection() {
            const sels = Array.from(document.querySelectorAll('.tf-sel:checked')).map(el => el.value);
            if (sels.length === 0) {
                document.getElementById('tfModal').style.display = 'none';
                return;
            }

            const spacesArgValue = sels.join(' ');
            const spacesArgLine = `--output-spaces ${spacesArgValue}`;
            
            // 1. Check if the user is already using Custom Arguments and it contains --output-spaces
            const customArgsEl = document.getElementById('custom_args');
            let customVal = customArgsEl.value.trim();
            
            if (customVal.includes('--output-spaces')) {
                // Update existing in custom args
                customArgsEl.value = customVal.replace(/--output-spaces\s+([^\-]+|$)/, spacesArgLine + ' ');
                document.getElementById('tfModal').style.display = 'none';
                showStatus(`Updated TemplateFlow spaces in Custom Arguments.`);
                return;
            }

            // 2. Look for --output-spaces in dynamic options
            let appliedToDynamic = false;
            document.querySelectorAll('.dynamic-opt, .dynamic-opt-multi').forEach(el => {
                const flag = el.dataset.flag;
                if (flag === '--output-spaces' || flag === '--space') {
                    if (el.tagName === 'TEXTAREA') {
                        el.value = sels.join('\n');
                        appliedToDynamic = true;
                    } else if (el.tagName === 'INPUT' && el.type === 'text') {
                        el.value = spacesArgValue;
                        appliedToDynamic = true;
                    }
                }
            });

            if (appliedToDynamic) {
                document.getElementById('tfModal').style.display = 'none';
                showStatus(`Applied ${sels.length} spaces to the App-Specific options section.`);
                return;
            }

            // 3. Last resort: Append to custom args
            customArgsEl.value = (customVal ? customVal + '\n' : '') + spacesArgLine;
            document.getElementById('tfModal').style.display = 'none';
            showStatus(`Added --output-spaces to Custom Arguments.`);
        }

        async function scanValidationPipelines() {
            const bids = document.getElementById('validation_bids_folder').value.trim();
            const deriv = document.getElementById('validation_derivatives_folder').value.trim();
            if (!bids || !deriv) {
                _setUtilityStatus(document.getElementById('validationStatusBox'), 'Set BIDS and Derivatives folders first.', true);
                return;
            }
            try {
                const resp = await fetch('/detect_validation_pipelines', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ bids_dir: bids, derivatives_dir: deriv })
                });
                const data = await resp.json();
                if (data.pipelines) {
                    const sel = document.getElementById('validation_pipeline');
                    sel.innerHTML = '<option value="">All detected pipelines</option>';
                    data.pipelines.forEach(p => {
                        const opt = new Option(p.charAt(0).toUpperCase() + p.slice(1), p);
                        sel.add(opt);
                    });
                    _setUtilityStatus(document.getElementById('validationStatusBox'), `Found ${data.pipelines.length} pipelines.`);
                } else if (data.error) {
                    _setUtilityStatus(document.getElementById('validationStatusBox'), data.error, true);
                }
            } catch (e) {
                console.error("Pipeline scan error:", e);
            }
        }

        async function fetchDockerTags() {
            const repo = document.getElementById('build_docker_repo').value.trim();
            const tagSelect = document.getElementById('build_docker_tag');
            const statusEl = document.getElementById('buildStatusBox');
            
            if (!repo) {
                _setUtilityStatus(statusEl, 'Please enter a Docker repository first.', true);
                return;
            }

            _setUtilityStatus(statusEl, `Fetching tags for ${repo}...`, false);
            tagSelect.disabled = true;
            tagSelect.innerHTML = '<option>Loading...</option>';

            try {
                const resp = await fetch('/get_docker_tags', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ repo: repo })
                });
                
                if (!resp.ok) {
                    const errorText = await resp.text();
                    let errMsg = `Server returned ${resp.status}`;
                    try {
                        const errJson = JSON.parse(errorText);
                        if (errJson.error) errMsg = errJson.error;
                    } catch(e) {}
                    _setUtilityStatus(statusEl, `Error: ${errMsg}`, true);
                    tagSelect.innerHTML = '<option value="latest">latest</option>';
                    return;
                }

                const data = await resp.json();
                
                if (data.tags && data.tags.length > 0) {
                    tagSelect.innerHTML = '';
                    data.tags.forEach(tag => {
                        const opt = document.createElement('option');
                        opt.value = tag;
                        opt.innerText = tag;
                        tagSelect.appendChild(opt);
                    });
                    _setUtilityStatus(statusEl, `Fetched ${data.tags.length} tags.`, false);
                } else if (data.error) {
                    _setUtilityStatus(statusEl, `Error: ${data.error}`, true);
                    tagSelect.innerHTML = '<option value="latest">latest</option>';
                } else {
                    _setUtilityStatus(statusEl, 'No tags found for this repository.', true);
                    tagSelect.innerHTML = '<option value="latest">latest</option>';
                }
            } catch (err) {
                console.error("Fetch tags error:", err);
                _setUtilityStatus(statusEl, `Failed to fetch tags: ${err.message || err}`, true);
                tagSelect.innerHTML = '<option value="latest">latest</option>';
            } finally {
                tagSelect.disabled = false;
            }
        }

        async function startApptainerBuild() {
            const statusEl = document.getElementById('buildStatusBox');
            const logEl = document.getElementById('buildOutput');
            const btn = document.getElementById('buildApptainerBtn');
            const payload = {
                output_dir: document.getElementById('build_output_dir').value.trim(),
                tmp_dir: document.getElementById('build_tmp_dir').value.trim(),
                docker_repo: document.getElementById('build_docker_repo').value.trim(),
                docker_tag: document.getElementById('build_docker_tag').value.trim(),
                dockerfile: document.getElementById('build_dockerfile').value.trim(),
                keep_temp: document.getElementById('build_keep_temp').checked
            };
            if (!payload.output_dir || !payload.tmp_dir) {
                _setUtilityStatus(statusEl, 'Output and temporary directories are required.', true);
                return;
            }
            if (!payload.dockerfile && (!payload.docker_repo || !payload.docker_tag)) {
                _setUtilityStatus(statusEl, 'Provide a Docker repo/tag or a Dockerfile path.', true);
                return;
            }
            btn.disabled = true;
            btn.innerText = 'Building...';
            _setUtilityStatus(statusEl, 'Starting Apptainer build...', false);
            try {
                const resp = await fetch('/build_apptainer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    _setUtilityStatus(statusEl, data.error || 'Build failed.', true);
                } else {
                    const message = data.output_image ? `Built ${data.output_image}` : 'Build completed';
                    _setUtilityStatus(statusEl, message, !data.success);
                }
                let logText = data.stdout || data.stderr || '';
                if (data.log_file) {
                    logText += (logText ? '\n\n' : '') + `Log saved at: ${data.log_file}`;
                }
                logEl.innerText = logText;
            } catch (err) {
                _setUtilityStatus(statusEl, 'Build request failed: ' + err.message, true);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Start Build';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchTab('runnerTab', document.getElementById('tabRunnerBtn'));
            toggleEngineFields();

            // Clear tags if repo changes
            const buildRepoInput = document.getElementById('build_docker_repo');
            if (buildRepoInput) {
                buildRepoInput.addEventListener('input', () => {
                    const tagSelect = document.getElementById('build_docker_tag');
                    if (tagSelect.options.length > 1 || (tagSelect.options.length === 1 && tagSelect.options[0].value !== 'latest')) {
                        tagSelect.innerHTML = '<option value="latest">latest</option>';
                    }
                });
            }
        });
    </script>
</body>
</html>
