<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIDS App Runner GUI</title>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        .card { background: white; border: 1px solid #dee2e6; padding: 0; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); overflow: hidden; }
        .card-header { background: #2c3e50; color: white; padding: 15px 20px; font-weight: 600; font-size: 1.1rem; }
        .card-body { padding: 25px; }
        .section-header { border-bottom: 2px solid #3498db; margin: 30px 0 15px 0; padding-bottom: 8px; color: #2c3e50; font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn { padding: 10px 18px; cursor: pointer; border: none; border-radius: 5px; font-weight: 600; transition: all 0.2s; font-size: 0.9rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-outline-secondary { background: #f8f9fa; color: #495057; border: 1px solid #ced4da; }
        .btn-outline-secondary:hover { background: #e9ecef; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #495057; }
        .form-control, .form-select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; font-size: 0.95rem; }
        .input-group { display: flex; align-items: stretch; gap: 0; }
        .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-group .btn { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: none; }
        .row { display: flex; flex-wrap: wrap; margin: 0 -12px; }
        .col-md-6 { width: 50%; padding: 0 12px; box-sizing: border-box; }
        .col-md-4 { width: 33.33%; padding: 0 12px; box-sizing: border-box; }
        .col-md-8 { width: 66.66%; padding: 0 12px; box-sizing: border-box; }
        .mb-3 { margin-bottom: 20px; }
        #browseModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content-dir { background: white; margin: 5vh auto; padding: 0; width: 90%; max-width: 800px; border-radius: 10px; height: 85vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header-dir { background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; padding: 15px 25px; border-radius: 10px 10px 0 0; }
        .modal-body-dir { overflow-y: auto; flex-grow: 1; padding: 20px 25px; }
        .dir-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f3f5; font-family: 'Courier New', Courier, monospace; display: flex; align-items: center; transition: background 0.1s; border-radius: 4px; }
        .dir-item:hover { background: #e7f3ff; color: #007bff; }
        .dir-item-icon { margin-right: 15px; font-size: 1.3rem; }
        #currentPathDisplay { background: #fff5f5; color: #c92a2a; padding: 12px 15px; border: 1px solid #ffa8a8; margin-bottom: 15px; border-radius: 6px; word-break: break-all; font-family: monospace; font-weight: bold; }
        .opt-section { margin-bottom: 12px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        .opt-section-header { background: #f8f9fa; padding: 12px 20px; cursor: pointer; font-weight: 700; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; transition: background 0.2s; color: #495057; }
        .opt-section-header:hover { background: #e9ecef; }
        .opt-section-content { display: none; padding: 20px; background: white; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 15px; }
        .opt-section.active .opt-section-content { display: grid; }
        .opt-section.active .opt-section-header { border-bottom: 1px solid #3498db; background: #e7f3ff; color: #004085; }
    </style>
</head>
<body>
    <div style="background: #2c3e50; color: white; padding: 20px; font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 30px; border-radius: 0 0 15px 15px;">
        BIDS App Runner Configuration
    </div>
    <div class="container">
        <div class="card">
            <div class="card-header">Configure Runner Parameters</div>
            <div class="card-body">
                <form id="configForm">
                    <div class="section-header">1. Data Paths</div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">BIDS Dataset Folder</label>
                            <div class="input-group">
                                <input type="text" id="bids_folder" class="form-control">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('bids_folder')">...</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Output Folder</label>
                            <div class="input-group">
                                <input type="text" id="output_folder" class="form-control">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('output_folder')">...</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Work/Temp Folder</label>
                            <div class="input-group">
                                <input type="text" id="tmp_folder" class="form-control">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('tmp_folder')">...</button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Templateflow (Optional)</label>
                            <div class="input-group">
                                <input type="text" id="templateflow_dir" class="form-control">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('templateflow_dir')">...</button>
                            </div>
                        </div>
                    </div>
                    <div class="section-header">2. Container Selection</div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Apptainer Images Folder</label>
                            <div class="input-group">
                                <input type="text" id="container_folder" class="form-control">
                                <button type="button" class="btn btn-outline-secondary" onclick="openBrowser('container_folder')">...</button>
                                <button type="button" class="btn btn-warning" onclick="scanContainers()">Scan</button>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Select App</label>
                            <div class="input-group">
                                <select id="container_select" class="form-select" onchange="checkAppVersion()"></select>
                                <button type="button" id="fetchHelpBtn" class="btn btn-primary" style="display:none;" onclick="fetchAppOptions()">Fetch Options</button>
                            </div>
                            <div id="versionAlert" style="margin-top: 5px; font-size: 0.85rem; display: none;"></div>
                        </div>
                    </div>
                    <div id="dynamicOptionsSection" style="display: none;">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>App Specific Options</span>
                            <a id="docLink" href="#" target="_blank" style="font-size: 0.8rem; color: #3498db;">üìñ Doc</a>
                        </div>
                        <div id="optionsContainer"></div>
                    </div>
                    <div class="section-header">3. Execution Details</div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Analysis Level</label>
                            <select class="form-select" id="analysis_level">
                                <option value="participant">Participant</option>
                                <option value="group">Group</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Parallel Jobs</label>
                            <input type="number" class="form-control" id="jobs" value="1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Config Filename</label>
                            <input type="text" class="form-control" id="config_name" placeholder="config.json">
                        </div>
                    </div>

                    <div class="section-header">4. Runner Options</div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Log Level</label>
                            <select class="form-select runner-opt" id="runner_log_level" data-flag="--log-level">
                                <option value="INFO">INFO</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                            <small style="color:#666; font-style:italic;">Detail level of the terminal output.</small>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Specific Subjects (Space separated)</label>
                            <input type="text" class="form-control runner-opt" id="runner_subjects" data-flag="--subjects" placeholder="sub-01 sub-02">
                            <small style="color:#666; font-style:italic;">Optional: Only process these IDs (e.g. sub-01 sub-02).</small>
                        </div>
                    </div>
                    <div class="row" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 0 0 20px 0; border: 1px solid #dee2e6;">
                        <div class="col-md-3">
                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--validate"> Validate Outputs</label>
                            <small style="display:block; font-size:0.75rem; color:#666; margin-bottom:12px;">Generate reports after processing.</small>

                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--validate-only"> Validate Only</label>
                            <small style="display:block; font-size:0.75rem; color:#666; margin-bottom:12px;">Skip app run, only check outputs.</small>

                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--dry-run"> Dry Run</label>
                            <small style="display:block; font-size:0.75rem; color:#666;">Preview commands without running.</small>
                        </div>
                        <div class="col-md-3">
                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--force"> Force Reprocess</label>
                            <small style="display:block; font-size:0.75rem; color:#666; margin-bottom:12px;">Overwrite existing output files.</small>

                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--pilot"> Pilot Mode</label>
                            <small style="display:block; font-size:0.75rem; color:#666;">Test run on 1 random subject.</small>
                        </div>
                        <div class="col-md-3">
                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--debug"> Debug Mode</label>
                            <small style="display:block; font-size:0.75rem; color:#666; margin-bottom:12px;">Show detailed container logs.</small>

                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--reprocess-missing"> Reprocess Missing</label>
                            <small style="display:block; font-size:0.75rem; color:#666;">Auto-run subjects with no outputs.</small>
                        </div>
                        <div class="col-md-3">
                            <label style="display:block; margin-bottom:2px; font-weight:600;"><input type="checkbox" class="runner-opt" data-flag="--clean-success-markers"> Clean Markers</label>
                            <small style="display:block; font-size:0.75rem; color:#666;">Force fresh detection of progress.</small>
                        </div>
                    </div>
                    
                    <div id="statusAlert" style="display:none; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center; font-weight: bold;"></div>

                    <div style="margin-top: 40px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" type="button" onclick="loadExistingConfig()">üìÇ Load Config</button>
                        <button class="btn btn-success" type="button" onclick="handleSaveAndRun(false)">üíæ Save Only</button>
                        <button class="btn btn-danger" type="button" onclick="handleSaveAndRun(true)">üöÄ Save & Run Now</button>
                        <button class="btn btn-warning" id="runApp" style="display: none;" type="button" onclick="executeNow()">‚ö° Run (Cached)</button>
                        <button class="btn btn-danger" id="killBtn" type="button" style="background:#000; color:#fff;" onclick="killApp()">üõë Stop runner</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Config Selector Modal -->
    <div id="configModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
        <div style="background:white; margin:10% auto; padding:20px; width:80%; max-width:500px; border-radius:8px;">
            <h3>Select Configuration to Load</h3>
            <div id="configList" style="max-height:300px; overflow-y:auto; margin: 15px 0; border: 1px solid #ddd; border-radius: 4px;"></div>
            <div style="text-align:right;">
                <button class="btn btn-outline-secondary" onclick="document.getElementById('configModal').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Directory Browser Modal -->
    <div id="browseModal">
        <div class="modal-content-dir">
            <div class="modal-header-dir">
                <h3>Folder Browser</h3>
                <span onclick="closeBrowser()" style="cursor:pointer; font-size: 24px;">&times;</span>
            </div>
            <div style="padding: 15px 25px;"><div id="currentPathDisplay"></div></div>
            <div class="modal-body-dir" id="dirListing"></div>
            <div style="padding: 20px; border-top: 1px solid #ddd; display: flex; justify-content: space-between;">
                <button class="btn btn-outline-secondary" onclick="goUp()">Go Up</button>
                <button class="btn btn-success" onclick="selectCurrentDir()">Select Current Folder</button>
            </div>
        </div>
    </div>

    <script>
        let currentTargetId = '';
        let browserCurrentPath = '/data/local/software';
        let lastSavedPath = '';

        function showStatus(msg, isError=false) {
            const el = document.getElementById('statusAlert');
            el.innerText = msg;
            el.style.display = 'block';
            el.style.background = isError ? '#f8d7da' : '#d4edda';
            el.style.color = isError ? '#721c24' : '#155724';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        async function loadExistingConfig() {
            const resp = await fetch('/list_configs');
            const data = await resp.json();
            const list = document.getElementById('configList');
            list.innerHTML = '';
            data.configs.forEach(cfg => {
                const d = document.createElement('div');
                d.className = 'dir-item';
                d.style.padding = '10px';
                d.innerText = cfg;
                d.onclick = () => loadConfigDetails(cfg);
                list.appendChild(d);
            });
            document.getElementById('configModal').style.display = 'block';
        }

        async function loadConfigDetails(filename) {
            document.getElementById('configModal').style.display = 'none';
            try {
                const resp = await fetch(`/get_config?name=${filename}`);
                const data = await resp.json();
                const cfg = data.config;
                
                document.getElementById('bids_folder').value = cfg.common.bids_folder || '';
                document.getElementById('output_folder').value = cfg.common.output_folder || '';
                document.getElementById('tmp_folder').value = cfg.common.tmp_folder || '';
                document.getElementById('templateflow_dir').value = cfg.common.templateflow_dir || '';
                document.getElementById('jobs').value = cfg.common.jobs || 1;
                document.getElementById('analysis_level').value = cfg.app.analysis_level || 'participant';
                document.getElementById('config_name').value = filename;

                const containerPath = cfg.common.container;
                if (containerPath) {
                    const folder = containerPath.substring(0, containerPath.lastIndexOf('/'));
                    const name = containerPath.substring(containerPath.lastIndexOf('/') + 1);
                    document.getElementById('container_folder').value = folder;
                    await scanContainers();
                    document.getElementById('container_select').value = name;
                    await fetchAppOptions();
                    
                    const options = cfg.app.options || [];
                    for (let i = 0; i < options.length; i++) {
                        const flag = options[i];
                        if (flag.startsWith('--') || flag.startsWith('-')) {
                            const els = document.querySelectorAll(`[data-flag="${flag}"]`);
                            if (els.length > 0) {
                                const nextVal = options[i+1];
                                if (nextVal && !nextVal.startsWith('-')) {
                                    els.forEach(el => {
                                        if (el.classList.contains('dynamic-opt-multi')) {
                                            let j = i + 1;
                                            while(j < options.length && !options[j].startsWith('-')) {
                                                const subEl = document.querySelector(`.dynamic-opt-multi[data-flag="${flag}"][value="${options[j]}"]`);
                                                if (subEl) subEl.checked = true;
                                                j++;
                                            }
                                            i = j - 1; 
                                        } else {
                                            el.value = nextVal;
                                            i++;
                                        }
                                    });
                                } else {
                                    els.forEach(el => { if (el.type === 'checkbox') el.checked = true; });
                                }
                            }
                        }
                    }
                }
                
                // Track current path and show run button
                const respConfig = await fetch('/save_config', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        filename: filename, 
                        config: cfg 
                    }) 
                });
                const saveRes = await respConfig.json();
                lastSavedPath = saveRes.path;
                document.getElementById('runApp').style.display = 'inline-block';
                
                showStatus("Config loaded and ready to run!");
            } catch (err) {
                showStatus("Error loading config: " + err.message, true);
            }
        }

        function openBrowser(id) {
            currentTargetId = id;
            const currentVal = document.getElementById(id).value;
            loadDirectory(currentVal || browserCurrentPath);
            document.getElementById('browseModal').style.display = 'block';
        }
        function closeBrowser() { document.getElementById('browseModal').style.display = 'none'; }
        
        async function loadDirectory(path) {
            const list = document.getElementById('dirListing');
            list.innerHTML = 'Loading...';
            try {
                const resp = await fetch('/list_dirs', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path }) });
                const data = await resp.json();
                browserCurrentPath = data.current_path;
                document.getElementById('currentPathDisplay').innerText = browserCurrentPath;
                list.innerHTML = '';
                data.items.forEach(item => {
                    const d = document.createElement('div');
                    d.className = 'dir-item';
                    d.innerHTML = 'üìÅ ' + item.name;
                    d.onclick = () => loadDirectory(item.path);
                    list.appendChild(d);
                });
            } catch (e) {
                list.innerHTML = '<div style="color:red">Error loading directory</div>';
            }
        }
        function goUp() {
            const parts = browserCurrentPath.split('/').filter(p => p.length > 0);
            parts.pop();
            loadDirectory('/' + parts.join('/'));
        }
        function selectCurrentDir() {
            document.getElementById(currentTargetId).value = browserCurrentPath;
            closeBrowser();
        }

        async function scanContainers() {
            const f = document.getElementById('container_folder').value;
            if (!f) return;
            const resp = await fetch('/list_containers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder: f }) });
            const data = await resp.json();
            const s = document.getElementById('container_select');
            s.innerHTML = '';
            if (data.containers) {
                data.containers.forEach(c => { s.add(new Option(c, c)); });
                checkAppVersion();
            }
            document.getElementById('fetchHelpBtn').style.display = 'block';
        }

        async function checkAppVersion() {
            const f = document.getElementById('container_folder').value;
            const c = document.getElementById('container_select').value;
            if (!c) return;
            
            const alertEl = document.getElementById('versionAlert');
            alertEl.style.display = 'none';

            try {
                const resp = await fetch('/check_container_version', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ container: f + '/' + c })
                });
                const data = await resp.json();
                
                if (data.is_newer) {
                    alertEl.innerHTML = `<span style="color: #e67e22; font-weight: bold;">‚ö†Ô∏è New version available: <a href="${data.changelog_url}" target="_blank" style="color: #d35400;"><u>${data.latest}</u></a></span> <span style="font-size: 0.75rem; color: #666;">(current: ${data.current})</span>`;
                    alertEl.style.display = 'block';
                } else if (data.latest) {
                    alertEl.innerHTML = `<span style="color: #27ae60; font-weight: bold;">‚úÖ Up to date (<a href="${data.changelog_url}" target="_blank" style="color: #27ae60;">${data.latest}</a>)</span>`;
                    alertEl.style.display = 'block';
                }
            } catch (e) {
                console.error("Version check failed", e);
            }
        }

        async function fetchAppOptions() {
            const f = document.getElementById('container_folder').value;
            const c = document.getElementById('container_select').value;
            if (!c) return;
            const containerEl = document.getElementById('optionsContainer');
            document.getElementById('dynamicOptionsSection').style.display = 'block';
            containerEl.innerHTML = '<div style="padding:20px; text-align:center;">Fetching help...</div>';
            
            // Trigger version check in parallel
            checkAppVersion();

            const resp = await fetch('/get_app_help', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ container: f + '/' + c }) });
            const data = await resp.json();
            if (data.app_info) { document.getElementById('docLink').href = data.app_info.url; }
            containerEl.innerHTML = '';
            if (data.sections) {
                data.sections.forEach((sec, idx) => {
                    const secDiv = document.createElement('div');
                    secDiv.className = 'opt-section' + (idx === 0 ? ' active' : '');
                    const h = document.createElement('div');
                    h.className = 'opt-section-header';
                    h.innerHTML = '<span>' + sec.title + '</span><span class="arrow">' + (idx === 0 ? '‚ñº' : '‚ñ∂') + '</span>';
                    h.onclick = () => {
                        const active = secDiv.classList.toggle('active');
                        h.querySelector('.arrow').innerText = active ? '‚ñº' : '‚ñ∂';
                    };
                    const content = document.createElement('div');
                    content.className = 'opt-section-content';
                    sec.options.forEach(opt => {
                        const item = document.createElement('div');
                        item.style.padding = '10px'; item.style.background = '#fcfcfc'; item.style.display = 'flex'; item.style.flexDirection = 'column'; item.style.justifyContent = 'space-between';
                        let input = '';
                        if (opt.choices && opt.choices.length > 0) {
                            if (opt.is_multiple) {
                                let chks = '';
                                opt.choices.forEach(ch => {
                                    chks += '<label style="display:block"><input type="checkbox" class="dynamic-opt-multi" data-flag="' + opt.flag + '" value="' + ch + '"> ' + ch + '</label>';
                                });
                                input = '<label class="form-label">' + opt.name + '</label><div style="max-height:100px;overflow:auto;border:1px solid #ccc;padding:5px;background:white;">' + chks + '</div>';
                            } else {
                                let opts = '<option value="">-- Default --</option>';
                                opt.choices.forEach(ch => { opts += '<option value="' + ch + '">' + ch + '</option>'; });
                                input = '<label class="form-label">' + opt.name + '</label><select class="dynamic-opt form-select" data-flag="' + opt.flag + '">' + opts + '</select>';
                            }
                        } else if (opt.has_value) {
                            input = '<label class="form-label">' + opt.name + '</label><input type="text" class="dynamic-opt form-control" data-flag="' + opt.flag + '">';
                        } else {
                            input = '<label style="font-weight:600; cursor:pointer;"><input type="checkbox" class="dynamic-opt" data-flag="' + opt.flag + '"> ' + opt.name + '</label>';
                        }
                        const desc = opt.description ? '<div style="font-size:0.7rem;color:#666;margin-top:8px;line-height:1.3;font-style:italic;border-top:1px solid #eee;padding-top:4px;">' + opt.description + '</div>' : '';
                        item.innerHTML = input + desc;
                        content.appendChild(item);
                    });
                    secDiv.appendChild(h); secDiv.appendChild(content); containerEl.appendChild(secDiv);
                });
            }
        }

        async function handleSaveAndRun(shouldRun) {
            const opts = [];
            document.querySelectorAll('.dynamic-opt').forEach(el => {
                if (el.type === 'checkbox') { if (el.checked) opts.push(el.dataset.flag); }
                else if (el.value.trim()) { opts.push(el.dataset.flag); opts.push(el.value.trim()); }
            });
            const multi = {};
            document.querySelectorAll('.dynamic-opt-multi').forEach(el => {
                if (el.checked) { const f = el.dataset.flag; if (!multi[f]) multi[f] = []; multi[f].push(el.value); }
            });
            for (const f in multi) { opts.push(f); multi[f].forEach(v => opts.push(v)); }
            
            const config = {
                common: {
                    bids_folder: document.getElementById('bids_folder').value,
                    output_folder: document.getElementById('output_folder').value,
                    tmp_folder: document.getElementById('tmp_folder').value,
                    templateflow_dir: document.getElementById('templateflow_dir').value,
                    container: document.getElementById('container_folder').value + '/' + document.getElementById('container_select').value,
                    jobs: parseInt(document.getElementById('jobs').value) || 1
                },
                app: { analysis_level: document.getElementById('analysis_level').value, options: opts }
            };
            
            const filename = document.getElementById('config_name').value || 'config.json';
            try {
                const resp = await fetch('/save_config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename, config }) });
                const data = await resp.json();
                lastSavedPath = data.path;
                document.getElementById('runApp').style.display = 'inline-block';
                showStatus('Configuration saved!');
                
                if (shouldRun) {
                    await executeNow();
                }
            } catch (err) {
                showStatus("Error saving: " + err.message, true);
            }
        }

        async function executeNow() {
            if (!confirm('Start BIDS App processing?')) return;
            showStatus("Validating paths...", false);
            
            const runnerArgs = [];
            document.querySelectorAll('.runner-opt').forEach(el => {
                const flag = el.dataset.flag;
                if (el.type === 'checkbox') {
                    if (el.checked) runnerArgs.push(flag);
                } else if (el.value.trim()) {
                    if (flag === '--subjects') {
                        runnerArgs.push(flag);
                        el.value.trim().split(/\s+/).forEach(s => runnerArgs.push(s));
                    } else {
                        runnerArgs.push(flag);
                        runnerArgs.push(el.value.trim());
                    }
                }
            });

            try {
                const resp = await fetch('/run_app', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        config_path: lastSavedPath,
                        runner_args: runnerArgs
                    }) 
                });
                const data = await resp.json();
                
                if (resp.status === 400 && data.details) {
                    alert("VALIDATION FAILED:\n\n" + data.details);
                    showStatus("Validation failed. Check paths.", true);
                } else if (!resp.ok) {
                    throw new Error(data.error || 'Server error');
                } else {
                    showStatus("üöÄ Running: " + data.message.split('.')[0]);
                    alert(data.message);
                }
            } catch (err) {
                showStatus("Error: " + err.message, true);
                alert("Execution Error: " + err.message);
            }
        }

        async function killApp() {
            if (!confirm('This will stop ALL running BIDS App processes started by this runner. Continue?')) return;
            try {
                const resp = await fetch('/kill_job', { method: 'POST' });
                const data = await resp.json();
                alert(data.message);
                showStatus("Stopped: " + data.message);
            } catch (err) {
                showStatus("Error stopping: " + err.message, true);
            }
        }

        // Remove old submit handler since we use handleSaveAndRun now
        document.getElementById('configForm').addEventListener('submit', (e) => e.preventDefault());
    </script>
</body>
</html>
